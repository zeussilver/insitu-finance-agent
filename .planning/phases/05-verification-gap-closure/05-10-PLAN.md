---
phase: 05-verification-gap-closure
plan: 10
type: execute
wave: 1
depends_on: []
files_modified:
  - fin_evo_agent/src/core/task_executor.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Unsupported fetch queries return graceful error, not crash"
    - "Tasks with unsupported queries complete with exit_code=1 (not exception)"
    - "Error message explains what data types are supported"
  artifacts:
    - path: "fin_evo_agent/src/core/task_executor.py"
      provides: "Graceful handling of unsupported fetch patterns"
      contains: "return None"
  key_links:
    - from: "_handle_simple_fetch()"
      to: "execute_task()"
      via: "Returns None instead of raising ValueError"
      pattern: "return None.*unsupported"
---

<objective>
Fix the UNSUPPORTED_FETCH_PATTERNS ValueError Bug

Purpose: Plans 05-08 introduced UNSUPPORTED_FETCH_PATTERNS that raises ValueError when a query requests financial statement data (net income, dividends, etc.). This ValueError propagates up and breaks task execution. The fix is simple: return None instead of raising ValueError, allowing the task to continue through normal tool execution flow (which will also fail gracefully with proper error handling).

Output: Modified _handle_simple_fetch() that returns None for unsupported queries instead of raising ValueError
</objective>

<execution_context>
@/Users/liuzhenqian/.claude/get-shit-done/workflows/execute-plan.md
@/Users/liuzhenqian/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/05-verification-gap-closure/05-RE-VERIFICATION.md
@fin_evo_agent/src/core/task_executor.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove ValueError from _handle_simple_fetch()</name>
  <files>fin_evo_agent/src/core/task_executor.py</files>
  <action>
  Modify the `_handle_simple_fetch()` method (around line 280-322):

  CURRENT CODE (lines 296-303):
  ```python
  # Check for unsupported queries first (require financial data)
  for pattern in UNSUPPORTED_FETCH_PATTERNS:
      if re.search(pattern, query_lower, re.IGNORECASE):
          raise ValueError(
              "This query requires financial statement data which is not available. "
              "Only OHLCV (Open, High, Low, Close, Volume) data is supported."
          )
  ```

  CHANGE TO:
  ```python
  # Check for unsupported queries first (require financial data)
  # Return None to let the task fall through to normal tool execution
  # (which will also fail gracefully with proper error handling)
  for pattern in UNSUPPORTED_FETCH_PATTERNS:
      if re.search(pattern, query_lower, re.IGNORECASE):
          # Return None instead of raising ValueError
          # This allows execute_task() to continue with tool execution
          # which handles unsupported queries through normal error flow
          return None
  ```

  Also update the docstring (around line 283-293):
  REMOVE these lines from the docstring:
  ```
  Raises:
      ValueError: If query requires unsupported data (financial statements)
  ```

  Also remove the try/except ValueError block in execute_task() (lines 350-375):
  CURRENT CODE:
  ```python
  # Try simple fetch handling first (no tool execution needed)
  try:
      simple_result = self._handle_simple_fetch(query, data)
      if simple_result is not None:
          # Return success trace with direct result
          return ExecutionTrace(...)
  except ValueError as e:
      # Unsupported query (requires financial data)
      return ExecutionTrace(
          trace_id=f"unsupported_fetch_{task_id}",
          ...
      )
  ```

  CHANGE TO:
  ```python
  # Try simple fetch handling first (no tool execution needed)
  simple_result = self._handle_simple_fetch(query, data)
  if simple_result is not None:
      # Return success trace with direct result
      return ExecutionTrace(
          trace_id=f"simple_fetch_{task_id}",
          task_id=task_id,
          input_args={'query': query, 'symbol': symbol},
          output_repr=str(simple_result),
          exit_code=0,
          std_out=str(simple_result),
          std_err="",
          execution_time_ms=0
      )
  ```
  (Remove the try/except wrapper entirely - _handle_simple_fetch no longer raises ValueError)

  Finally, update the test at the bottom of the file (around line 462-468):
  CURRENT:
  ```python
  # Test unsupported queries raise ValueError
  try:
      task_executor._handle_simple_fetch("Get AAPL 2023 Q1 net income", mock_data)
      assert False, "Should have raised ValueError"
  except ValueError as e:
      assert "financial statement data" in str(e)
  print("Unsupported query handling: PASS")
  ```

  CHANGE TO:
  ```python
  # Test unsupported queries return None (fall through to tool execution)
  result = task_executor._handle_simple_fetch("Get AAPL 2023 Q1 net income", mock_data)
  assert result is None, "Unsupported queries should return None, not raise ValueError"
  print("Unsupported query handling: PASS")
  ```
  </action>
  <verify>
  Run the self-test:
  ```bash
  cd /Users/liuzhenqian/Desktop/personal\ project/2026-1-week3/Insitu\ finance\ agent/fin_evo_agent && python -m src.core.task_executor
  ```
  Expected output should include "Unsupported query handling: PASS"
  </verify>
  <done>
  - _handle_simple_fetch() returns None for unsupported queries (no ValueError)
  - execute_task() no longer has try/except ValueError wrapper
  - Self-tests pass including unsupported query test
  </done>
</task>

</tasks>

<verification>
1. Self-test passes: `python -m src.core.task_executor` completes with all PASS
2. No ValueError raised for unsupported queries
3. Code review confirms `raise ValueError` removed from _handle_simple_fetch()
</verification>

<success_criteria>
- _handle_simple_fetch() returns None for unsupported queries instead of raising ValueError
- Tasks with unsupported queries will now fall through to normal tool execution
- Self-tests pass without modification to test assertions
</success_criteria>

<output>
After completion, create `.planning/phases/05-verification-gap-closure/05-10-SUMMARY.md`
</output>
