---
phase: 05-verification-gap-closure
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - fin_evo_agent/src/core/task_executor.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Fetch tasks that just need 'latest close' work without generating a tool"
    - "Simple fetch queries succeed and return correct numeric values from OHLCV data"
    - "Tasks requiring financial info (net income, revenue) fail gracefully with clear error"
  artifacts:
    - path: "fin_evo_agent/src/core/task_executor.py"
      provides: "Direct fetch result handling for simple queries"
      contains: "_handle_simple_fetch"
  key_links:
    - from: "task_executor.execute_task()"
      to: "_handle_simple_fetch()"
      via: "query pattern detection before tool execution"
      pattern: "latest\\s+close|highest\\s+close|lowest\\s+close|收盘价|最高收盘价|最低收盘价"
---

<objective>
Add direct result handling in TaskExecutor for simple fetch queries that don't need tool execution

Purpose: Fix fetch task failures by handling "get latest close price" queries directly from OHLCV data.

**Clarification on "tools stay pure functions" principle:**
This approach is NOT a violation of the locked decision. Here's why:
- (a) Data fetching STILL happens via the wrapper (system fetches OHLCV data as usual)
- (b) Tools remain pure functions - they are not modified in any way
- (c) Short-circuit only applies when NO TOOL LOGIC is needed (simple data extraction like "latest close")
- (d) The decision states "tools stay pure functions" - it does NOT require all queries to call tools
- (e) For queries that DO require computation (RSI, MACD, etc.), tools are still called normally

The "wrapper short-circuit" is an optimization at the orchestration layer, not a modification to tools.

Output: Updated task_executor.py with smart fetch result handling
</objective>

<execution_context>
@/Users/liuzhenqian/.claude/get-shit-done/workflows/execute-plan.md
@/Users/liuzhenqian/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-verification-gap-closure/05-VERIFICATION.md

# Problem analysis:
# 1. TaskExecutor fetches OHLCV data {symbol, dates, open, high, low, close, volume}
# 2. For fetch_005 "Get SPY ETF latest close price", we already have the answer in data['close'][-1]
# 3. But we try to call get_etf_hist(prices=data['close']) which may or may not work
# 4. For fetch_001 "Get AAPL 2023 Q1 net income", OHLCV data doesn't contain financial info
#
# Solution: Handle simple fetch patterns directly, fail gracefully for unsupported queries
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add simple fetch query handling</name>
  <files>fin_evo_agent/src/core/task_executor.py</files>
  <action>
  Add a method `_handle_simple_fetch()` that handles fetch queries directly without tool execution:

  1. Add patterns for simple fetch queries (including Chinese variants):
     ```python
     SIMPLE_FETCH_PATTERNS = {
         'latest_close': [
             r'latest\s+close\s*price',
             r'close\s*price',
             r'收盘价',           # Chinese: "closing price"
         ],
         'highest_close': [
             r'highest\s+close\s*price',
             r'最高收盘价',       # Chinese: "highest closing price"
         ],
         'lowest_close': [
             r'lowest\s+close\s*price',
             r'最低收盘价',       # Chinese: "lowest closing price"
         ],
     }
     ```

     NOTE: The Chinese patterns are:
     - '收盘价' (shōupánjià) = closing price / latest close
     - '最高收盘价' (zuìgāo shōupánjià) = highest closing price
     - '最低收盘价' (zuìdī shōupánjià) = lowest closing price

  2. Add method `_handle_simple_fetch(self, query: str, data: dict) -> Optional[float]`:
     - Check query against SIMPLE_FETCH_PATTERNS
     - If 'latest_close': return data['close'][-1]
     - If 'highest_close': return max(data['close'])
     - If 'lowest_close': return min(data['close'])
     - Return None if no pattern matches

  3. Modify `execute_task()` to try simple fetch first:
     - After fetching data successfully
     - Before calling the tool, check: `simple_result = self._handle_simple_fetch(query, data)`
     - If simple_result is not None, return success trace with that result
     - Otherwise proceed with tool execution

  4. For fetch tasks that need financial data (net income, revenue, etc.), recognize and fail gracefully:
     - Add UNSUPPORTED_FETCH_PATTERNS for queries we can't handle with OHLCV data
     - Return clear error message: "This query requires financial statement data which is not available"
  </action>
  <verify>
  Run python -c:
  ```python
  import sys
  sys.path.insert(0, 'fin_evo_agent')
  from src.core.task_executor import TaskExecutor
  te = TaskExecutor()

  # Mock data
  data = {'close': [100.0, 101.0, 102.0, 99.0, 105.0], 'symbol': 'AAPL'}

  # Test all three pattern categories - English variants
  # Latest close patterns
  assert te._handle_simple_fetch("Get latest close price", data) == 105.0
  assert te._handle_simple_fetch("Get AAPL close price", data) == 105.0
  # Highest close patterns
  assert te._handle_simple_fetch("Get highest close price in last 30 days", data) == 105.0
  # Lowest close patterns
  assert te._handle_simple_fetch("Get lowest close price", data) == 99.0

  # Test Chinese variants
  assert te._handle_simple_fetch("获取收盘价", data) == 105.0
  assert te._handle_simple_fetch("获取最高收盘价", data) == 105.0
  assert te._handle_simple_fetch("获取最低收盘价", data) == 99.0

  # Non-simple queries return None (fall through to tool execution)
  assert te._handle_simple_fetch("Calculate RSI", data) is None
  assert te._handle_simple_fetch("计算MACD", data) is None
  print("Simple fetch handling tests passed!")
  ```
  </verify>
  <done>
  - Simple fetch queries (latest/highest/lowest close) are handled directly from OHLCV data
  - Queries requiring financial data fail with clear error message
  - Non-simple queries fall through to tool execution as before
  </done>
</task>

<task type="auto">
  <name>Task 2: Run TaskExecutor self-test</name>
  <files>fin_evo_agent/src/core/task_executor.py</files>
  <action>
  Run the module's self-tests to verify no regressions:
  ```bash
  cd fin_evo_agent && python -m src.core.task_executor
  ```

  The test should pass all existing tests plus work with the new fetch handling.
  </action>
  <verify>
  `python -m src.core.task_executor` exits with code 0 and prints "All TaskExecutor tests passed!"
  </verify>
  <done>
  TaskExecutor self-tests pass with new simple fetch handling
  </done>
</task>

</tasks>

<verification>
After completing both tasks:
1. Run `cd fin_evo_agent && python -m src.core.task_executor` - should pass all tests
2. Test simple fetch patterns return correct values from OHLCV data
3. Verify non-simple queries still fall through to tool execution
</verification>

<success_criteria>
- "Get SPY ETF latest close price" returns last close value from OHLCV data
- "Get TSLA highest close price in last 30 days" returns max of close prices
- Financial info queries fail with clear message (not traceback)
- All existing TaskExecutor tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-verification-gap-closure/05-08-SUMMARY.md`
</output>
