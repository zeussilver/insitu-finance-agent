---
phase: 05-verification-gap-closure
plan: 11
type: execute
wave: 1
depends_on: []
files_modified:
  - fin_evo_agent/src/core/task_executor.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Symbol extraction does not match 'DOW' substring in 'drawdown'"
    - "calc_007 (MSFT max drawdown) extracts MSFT, not ^DJI"
    - "Index names still map correctly when used as standalone words"
  artifacts:
    - path: "fin_evo_agent/src/core/task_executor.py"
      provides: "Word boundary matching for index names"
      contains: "\\b"
  key_links:
    - from: "extract_symbol()"
      to: "INDEX_SYMBOL_MAPPING"
      via: "Word boundary regex matching"
      pattern: "r'\\\\b.*\\\\b'"
---

<objective>
Fix the Symbol Extraction "DOW" in "drawdown" Bug

Purpose: The INDEX_SYMBOL_MAPPING check in extract_symbol() uses simple substring matching (`if index_name.upper() in query_upper`), which incorrectly matches "DOW" inside the word "drawdown". This causes calc_007 ("Calculate MSFT max drawdown over last 250 days") to extract ^DJI instead of MSFT. The fix: use word boundary regex matching.

Output: Modified extract_symbol() that uses word boundary regex (\b) for index name matching
</objective>

<execution_context>
@/Users/liuzhenqian/.claude/get-shit-done/workflows/execute-plan.md
@/Users/liuzhenqian/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/05-verification-gap-closure/05-RE-VERIFICATION.md
@fin_evo_agent/src/core/task_executor.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add word boundary matching for index names</name>
  <files>fin_evo_agent/src/core/task_executor.py</files>
  <action>
  Modify the extract_symbol() method (around line 115-152):

  CURRENT CODE (lines 126-129):
  ```python
  # Step 1: Check index names FIRST (case-insensitive)
  for index_name, symbol in self.INDEX_SYMBOL_MAPPING.items():
      if index_name.upper() in query_upper:
          return symbol
  ```

  CHANGE TO:
  ```python
  # Step 1: Check index names FIRST (case-insensitive, word boundary)
  # Use word boundary regex to avoid matching "DOW" in "drawdown"
  for index_name, symbol in self.INDEX_SYMBOL_MAPPING.items():
      # Escape regex special chars in index name (e.g., "S&P" has &)
      escaped_name = re.escape(index_name)
      # Match as complete word/phrase (word boundaries)
      pattern = r'\b' + escaped_name + r'\b'
      if re.search(pattern, query, re.IGNORECASE):
          return symbol
  ```

  NOTE: Use `query` (original case) instead of `query_upper` since re.IGNORECASE handles case-insensitivity.

  Also add a test case for the "drawdown" edge case in the __main__ block (around line 418-420):
  After the existing index mapping tests, add:
  ```python
  # Test that "DOW" in "drawdown" does NOT match (word boundary)
  assert task_executor.extract_symbol("Calculate MSFT max drawdown over last 250 days") == "MSFT", "Should extract MSFT, not match DOW in drawdown"
  print("Symbol extraction (drawdown edge case): PASS")
  ```
  </action>
  <verify>
  Run the self-test:
  ```bash
  cd /Users/liuzhenqian/Desktop/personal\ project/2026-1-week3/Insitu\ finance\ agent/fin_evo_agent && python -m src.core.task_executor
  ```
  Expected output should include:
  - "Symbol extraction: PASS"
  - "Symbol extraction (drawdown edge case): PASS"
  </verify>
  <done>
  - extract_symbol() uses word boundary regex for INDEX_SYMBOL_MAPPING
  - "DOW" in "drawdown" no longer matches ^DJI
  - "MSFT max drawdown" correctly extracts MSFT
  - Standalone "DOW" still correctly maps to ^DJI
  - All self-tests pass
  </done>
</task>

</tasks>

<verification>
1. Self-test passes: `python -m src.core.task_executor` completes with all PASS
2. Test specifically for "drawdown" edge case passes
3. Existing index mapping tests still pass (S&P 500 -> ^GSPC, DOW -> ^DJI)
</verification>

<success_criteria>
- extract_symbol("Calculate MSFT max drawdown") returns "MSFT", not "^DJI"
- extract_symbol("Get DOW Jones index") still returns "^DJI"
- extract_symbol("Get S&P 500 index") still returns "^GSPC"
- All existing symbol extraction tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-verification-gap-closure/05-11-SUMMARY.md`
</output>
