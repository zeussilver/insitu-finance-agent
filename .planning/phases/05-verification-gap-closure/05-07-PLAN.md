---
phase: 05-verification-gap-closure
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - fin_evo_agent/src/core/task_executor.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "extract_symbol() does not match common English words like GET, AND, THE, FOR"
    - "fetch_004 (S&P 500 index) extracts valid symbol or returns sensible default"
    - "fetch_005 (SPY ETF) extracts SPY, not GET"
  artifacts:
    - path: "fin_evo_agent/src/core/task_executor.py"
      provides: "Fixed symbol extraction logic"
      contains: "SYMBOL_EXCLUSIONS"
  key_links:
    - from: "task_executor.extract_symbol()"
      to: "SYMBOL_EXCLUSIONS set"
      via: "exclusion check before pattern match"
      pattern: "if.*SYMBOL_EXCLUSIONS"
---

<objective>
Fix TaskExecutor.extract_symbol() to not match common English words like "GET" as ticker symbols

Purpose: Fix 2 regressions (fetch_004, fetch_005) caused by regex matching "GET" instead of actual symbols
Output: Updated task_executor.py with proper symbol extraction logic
</objective>

<execution_context>
@/Users/liuzhenqian/.claude/get-shit-done/workflows/execute-plan.md
@/Users/liuzhenqian/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-verification-gap-closure/05-VERIFICATION.md

# The failing queries:
# fetch_004: "Get S&P 500 index latest close price" -> matches "GET" instead of proper index symbol
# fetch_005: "Get SPY ETF latest close price" -> matches "GET" before finding "SPY"
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add symbol exclusion list and fix extraction order</name>
  <files>fin_evo_agent/src/core/task_executor.py</files>
  <action>
  Modify extract_symbol() method in TaskExecutor class:

  1. Add SYMBOL_EXCLUSIONS class constant (set) containing common English words that look like tickers:
     ```python
     SYMBOL_EXCLUSIONS = {
         'GET', 'SET', 'PUT', 'AND', 'THE', 'FOR', 'NOT', 'ALL', 'HAS',
         'ADD', 'SUB', 'DIV', 'MUL', 'MAX', 'MIN', 'AVG', 'SUM', 'END',
         'NEW', 'OLD', 'TOP', 'LOW', 'NET', 'DAY', 'ETF', 'USA', 'USD'
     }
     ```

  2. Add index symbol mapping for common index names:
     ```python
     INDEX_SYMBOL_MAPPING = {
         'S&P 500': '^GSPC',
         'S&P500': '^GSPC',
         'SP500': '^GSPC',
         'DOW': '^DJI',
         'DJIA': '^DJI',
         'NASDAQ': '^IXIC',
         'RUSSELL': '^RUT',
     }
     ```

  3. Modify extract_symbol() logic with EXPLICIT execution order:

     **Step 3a (FIRST - Index mapping):** Check INDEX_SYMBOL_MAPPING keys against query
       - For each key in INDEX_SYMBOL_MAPPING, check if key appears in query (case-insensitive)
       - If match found, RETURN INDEX_SYMBOL_MAPPING[key] immediately (e.g., "S&P 500" → "^GSPC")
       - This runs BEFORE any regex matching

     **Step 3b (SECOND - Known US tickers):** Check against us_tickers list
       - Check if any ticker from us_tickers appears in the query
       - If found, return that ticker
       - This catches common symbols like AAPL, MSFT, SPY before regex runs

     **Step 3c (THIRD - Regex with exclusions):** Run regex pattern matching
       - Use existing regex to find potential ticker patterns ([A-Z]{1,5})
       - FILTER OUT any matches that appear in SYMBOL_EXCLUSIONS set
       - Return first valid match that passes exclusion filter

     **Step 3d (LAST - Default fallback):** Return 'AAPL' as default
       - Only if steps 3a, 3b, and 3c all found nothing valid

  4. The regex pattern should also prefer longer matches over shorter ones to avoid "GET" when "GETH" exists.
  </action>
  <verify>
  Run python -c:
  ```python
  import sys
  sys.path.insert(0, 'fin_evo_agent')
  from src.core.task_executor import TaskExecutor
  te = TaskExecutor()
  # Test cases for regressions - fix GET matching
  assert te.extract_symbol("Get S&P 500 index latest close price") != "GET", "Should not match GET"
  assert te.extract_symbol("Get SPY ETF latest close price") == "SPY", "Should match SPY, not GET"
  # Test INDEX_SYMBOL_MAPPING functionality
  assert te.extract_symbol("Get S&P 500 index latest close price") == "^GSPC", "Should map S&P 500 to ^GSPC"
  assert te.extract_symbol("Get DOW Jones index price") == "^DJI", "Should map DOW to ^DJI"
  assert te.extract_symbol("Get NASDAQ composite") == "^IXIC", "Should map NASDAQ to ^IXIC"
  # Original cases still work
  assert te.extract_symbol("计算AAPL的RSI") == "AAPL"
  assert te.extract_symbol("计算MSFT的MACD") == "MSFT"
  print("All symbol extraction tests passed!")
  ```
  </verify>
  <done>
  - extract_symbol("Get S&P 500 index latest close price") returns "^GSPC" (S&P 500 index symbol)
  - extract_symbol("Get SPY ETF latest close price") returns "SPY" (not "GET")
  - All existing symbol extraction tests still pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Run TaskExecutor self-test</name>
  <files>fin_evo_agent/src/core/task_executor.py</files>
  <action>
  Run the module's `if __name__ == '__main__'` tests to verify no regressions:
  ```bash
  cd fin_evo_agent && python -m src.core.task_executor
  ```

  Ensure output shows:
  - Symbol extraction: PASS
  - Date extraction: PASS
  - Param extraction: PASS
  - All TaskExecutor tests passed!
  </action>
  <verify>
  `python -m src.core.task_executor` exits with code 0 and prints "All TaskExecutor tests passed!"
  </verify>
  <done>
  TaskExecutor self-tests pass with the new symbol extraction logic
  </done>
</task>

</tasks>

<verification>
After completing both tasks:
1. Run `cd fin_evo_agent && python -m src.core.task_executor` - should pass all tests
2. Verify extract_symbol() returns correct symbols for the failing queries
3. Confirm no regressions on existing symbol extraction behavior
</verification>

<success_criteria>
- extract_symbol() excludes common English words (GET, SET, PUT, etc.)
- Index names (S&P 500, DOW, NASDAQ) map to proper yfinance symbols
- fetch_004 and fetch_005 no longer fail due to "No data returned for GET"
- All existing TaskExecutor tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-verification-gap-closure/05-07-SUMMARY.md`
</output>
