---
phase: 05-verification-gap-closure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - fin_evo_agent/src/core/models.py
autonomous: true

must_haves:
  truths:
    - "ToolArtifact has category field for task type classification"
    - "ToolArtifact has indicator field for technical indicator type"
    - "ToolArtifact has data_type field for data requirements"
    - "ToolArtifact has input_requirements field for required parameters"
    - "Database migration preserves existing tools"
  artifacts:
    - path: "fin_evo_agent/src/core/models.py"
      provides: "Extended ToolArtifact with schema fields"
      contains: "category: Optional[str]"
  key_links:
    - from: "ToolArtifact model"
      to: "SQLite database"
      via: "SQLModel metadata.create_all()"
      pattern: "Field.*index=True"
---

<objective>
Add structured schema fields to ToolArtifact model for semantic tool matching.

Purpose: The current keyword-based `_infer_tool_name()` in run_eval.py matches wrong tools to similar-sounding tasks. By storing structured metadata (category, indicator, data_type, input_requirements) in the database, we enable precise schema-based matching instead of fuzzy keyword matching.

Output: Extended ToolArtifact model with 4 new optional fields, database schema automatically updated on next init_db() call.
</objective>

<execution_context>
@/Users/liuzhenqian/.claude/get-shit-done/workflows/execute-plan.md
@/Users/liuzhenqian/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-verification-gap-closure/05-CONTEXT.md
@.planning/phases/05-verification-gap-closure/05-RESEARCH.md
@fin_evo_agent/src/core/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add schema fields to ToolArtifact model</name>
  <files>fin_evo_agent/src/core/models.py</files>
  <action>
Add 4 new optional fields to the ToolArtifact class, after the existing `test_cases` field:

```python
# --- Structured matching fields (Phase 5) ---
# These fields enable schema-based tool matching instead of keyword matching
category: Optional[str] = Field(default=None, index=True,
    description="Task category: 'fetch', 'calculation', 'composite'")
indicator: Optional[str] = Field(default=None, index=True,
    description="Technical indicator: 'rsi', 'macd', 'bollinger', 'kdj', etc.")
data_type: Optional[str] = Field(default=None,
    description="Data type: 'price', 'financial', 'volume', 'ohlcv'")
input_requirements: List[str] = Field(default=[], sa_column=Column(JSON),
    description="Required input fields: ['prices', 'period'], ['symbol', 'start', 'end']")
```

The field placement should be:
1. After `test_cases: List[Dict] = ...`
2. Before `created_at: datetime = ...`

Ensure the import for `Optional` from typing is present (it already is).
  </action>
  <verify>
Run:
```bash
cd fin_evo_agent && python -c "
from src.core.models import ToolArtifact
import inspect

# Check fields exist
fields = ToolArtifact.model_fields
assert 'category' in fields, 'Missing category field'
assert 'indicator' in fields, 'Missing indicator field'
assert 'data_type' in fields, 'Missing data_type field'
assert 'input_requirements' in fields, 'Missing input_requirements field'

print('All 4 schema fields present in ToolArtifact:')
for name in ['category', 'indicator', 'data_type', 'input_requirements']:
    field = fields[name]
    print(f'  - {name}: {field.annotation}')
print('PASS')
"
```
  </verify>
  <done>
- ToolArtifact has `category: Optional[str]` field (indexed)
- ToolArtifact has `indicator: Optional[str]` field (indexed)
- ToolArtifact has `data_type: Optional[str]` field
- ToolArtifact has `input_requirements: List[str]` field (JSON column)
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify database migration works</name>
  <files>fin_evo_agent/src/core/models.py</files>
  <action>
SQLModel/SQLAlchemy's `metadata.create_all()` adds new columns to existing tables without data loss. Verify this works:

1. Run init_db() to update the schema
2. List existing tools to confirm they're preserved
3. Create a test tool with new fields to confirm they work

Note: SQLite's ALTER TABLE has limitations, but SQLModel handles adding nullable columns correctly.
  </action>
  <verify>
Run:
```bash
cd fin_evo_agent && python -c "
from src.core.models import init_db, ToolArtifact, get_engine
from src.core.registry import ToolRegistry
from sqlmodel import Session, select

# 1. Initialize/migrate database
print('Initializing database...')
init_db()

# 2. Check existing tools are preserved
registry = ToolRegistry()
tools = registry.list_tools()
print(f'Existing tools preserved: {len(tools)} tools found')

# 3. Test new fields work with a query
engine = get_engine()
with Session(engine) as session:
    # Query with new field filter
    query = select(ToolArtifact).where(ToolArtifact.category == 'calculation')
    results = list(session.exec(query).all())
    print(f'Query with category filter works: {len(results)} results')

    # Test creating with new fields
    from src.core.models import ToolStatus, Permission
    test_tool = ToolArtifact(
        name='test_schema_tool',
        semantic_version='0.1.0',
        file_path='test/path.py',
        content_hash='test_hash_12345',
        code_content='def test(): pass',
        category='calculation',
        indicator='rsi',
        data_type='price',
        input_requirements=['prices', 'period']
    )
    # Don't actually save - just verify it constructs
    print(f'New tool with schema fields: category={test_tool.category}, indicator={test_tool.indicator}')

print('PASS: Database migration successful')
"
```
  </verify>
  <done>
- init_db() completes without error
- Existing tools are preserved after migration
- Queries with new field filters work
- New ToolArtifact instances can be created with schema fields
  </done>
</task>

</tasks>

<verification>
1. ToolArtifact model has all 4 new fields
2. Database schema is updated (new columns exist)
3. Existing tool data is preserved
4. New tools can be created with schema fields
5. Queries can filter by category and indicator
</verification>

<success_criteria>
- `category: Optional[str]` field exists and is indexed
- `indicator: Optional[str]` field exists and is indexed
- `data_type: Optional[str]` field exists
- `input_requirements: List[str]` field exists (JSON column)
- Database migration preserves existing tools
- No breaking changes to existing code
</success_criteria>

<output>
After completion, create `.planning/phases/05-verification-gap-closure/05-02-SUMMARY.md`
</output>
