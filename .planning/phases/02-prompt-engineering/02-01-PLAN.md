---
phase: 02-prompt-engineering
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - fin_evo_agent/src/core/llm_adapter.py
autonomous: true

must_haves:
  truths:
    - "Generated calculation tools accept prices: list as first parameter"
    - "Generated tools do not import yfinance or akshare"
    - "Generated tools do not import talib"
    - "Generated tools return float for numeric values, dict for structured output"
    - "Test blocks use inline hardcoded sample data (not API calls)"
  artifacts:
    - path: "fin_evo_agent/src/core/llm_adapter.py"
      provides: "Enhanced SYSTEM_PROMPT with pure function pattern"
      contains: "Accept price/financial data as function ARGUMENTS"
  key_links:
    - from: "SYSTEM_PROMPT"
      to: "LLMAdapter.generate_tool_code()"
      via: "messages[0].content"
      pattern: "SYSTEM_PROMPT"
---

<objective>
Enhance SYSTEM_PROMPT in llm_adapter.py to guide the LLM toward generating pure calculation functions that accept data as arguments, use only pandas/numpy for calculations, and return properly typed results.

Purpose: The current SYSTEM_PROMPT allows generated tools to fetch data internally (yfinance calls) and doesn't enforce return type conventions. This causes tools to be non-reusable and fail in sandboxed execution. The improved prompt enforces the "pure function" pattern demonstrated by the mock LLM output.

Output: Updated SYSTEM_PROMPT with explicit instructions for data-as-arguments pattern, pandas/numpy-only calculations, typed returns, and inline test data.
</objective>

<execution_context>
@/Users/liuzhenqian/.claude/get-shit-done/workflows/execute-plan.md
@/Users/liuzhenqian/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-prompt-engineering/02-RESEARCH.md
@fin_evo_agent/src/core/llm_adapter.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance SYSTEM_PROMPT with pure function pattern instructions</name>
  <files>fin_evo_agent/src/core/llm_adapter.py</files>
  <action>
Replace the current SYSTEM_PROMPT (lines 19-34) with an enhanced version that includes:

1. **Data-as-arguments instruction** (PROMPT-04, DATA-01):
   - Add: "Accept price/financial data as function ARGUMENTS (e.g., `prices: list` or `prices: pd.Series`)"
   - Add: "Do NOT call yfinance, akshare, or any data API inside the function - data is passed IN"

2. **Pandas/numpy-only instruction** (PROMPT-03):
   - Change allowed imports line from "pandas, numpy, datetime, json, math, decimal, collections, re, yfinance, pathlib" to "pandas, numpy, datetime, json, math, decimal, collections, re, typing"
   - Add: "Use ONLY pandas and numpy for calculations - NO talib, NO external indicator libraries"
   - Add FORBIDDEN list: "yfinance, akshare, talib, requests, urllib"

3. **Return type guidance** (DATA-03):
   - Add: "Return typed results: float for single numeric values, dict for multiple values, bool for conditions"

4. **Test data instruction** (DATA-02):
   - Add: "Include 2 assert tests in `if __name__ == '__main__':` block using INLINE sample data"
   - Add: "Test data must be INLINE hardcoded lists, NOT fetched from APIs"

5. **Generic function naming**:
   - Add: "Function names should be GENERIC (e.g., `calc_rsi`, not `calc_aapl_rsi`)"

6. **Add example of correct pattern** (copy from research):
   ```python
   EXAMPLE of correct pattern:
   import pandas as pd
   import numpy as np

   def calc_rsi(prices: list, period: int = 14) -> float:
       """Calculate RSI indicator.

       Args:
           prices: List of closing prices
           period: RSI period (default 14)

       Returns:
           RSI value between 0 and 100
       """
       # Implementation using pandas only...
       return float(result)

   if __name__ == "__main__":
       test_prices = [44, 44.5, 44.25, 43.75, 44.5, 44.25, 44.5, 45, 45.5, 46]
       result = calc_rsi(test_prices, 5)
       assert 0 <= result <= 100
   ```

Use the exact improved SYSTEM_PROMPT from the research document (Example 2) as the template.
  </action>
  <verify>
Run these verification commands:

```bash
# 1. Verify yfinance removed from allowed imports in prompt
cd fin_evo_agent && python3 -c "from src.core.llm_adapter import SYSTEM_PROMPT; assert 'yfinance' not in SYSTEM_PROMPT.split('Allowed imports:')[1].split('FORBIDDEN')[0] if 'Allowed imports:' in SYSTEM_PROMPT else False, 'yfinance still in allowed imports'"

# 2. Verify FORBIDDEN list exists
python3 -c "from src.core.llm_adapter import SYSTEM_PROMPT; assert 'FORBIDDEN' in SYSTEM_PROMPT and 'yfinance' in SYSTEM_PROMPT.split('FORBIDDEN')[1][:100], 'FORBIDDEN list missing or incomplete'"

# 3. Verify data-as-arguments instruction exists
python3 -c "from src.core.llm_adapter import SYSTEM_PROMPT; assert 'function ARGUMENTS' in SYSTEM_PROMPT or 'data as function' in SYSTEM_PROMPT.lower(), 'Data-as-arguments instruction missing'"

# 4. Verify return type guidance exists
python3 -c "from src.core.llm_adapter import SYSTEM_PROMPT; assert 'float for' in SYSTEM_PROMPT and 'dict for' in SYSTEM_PROMPT, 'Return type guidance missing'"

# 5. Verify inline test data instruction exists
python3 -c "from src.core.llm_adapter import SYSTEM_PROMPT; assert 'INLINE' in SYSTEM_PROMPT or 'inline' in SYSTEM_PROMPT, 'Inline test data instruction missing'"

# 6. Verify example pattern is included
python3 -c "from src.core.llm_adapter import SYSTEM_PROMPT; assert 'def calc_rsi(prices: list' in SYSTEM_PROMPT, 'Example pattern missing'"
```

All commands should exit with code 0.
  </verify>
  <done>
SYSTEM_PROMPT in llm_adapter.py contains:
- Data-as-arguments instruction ("Accept price/financial data as function ARGUMENTS")
- yfinance removed from allowed imports, added to FORBIDDEN list
- Return type guidance (float/dict/bool)
- Inline test data instruction
- Example showing correct pattern
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify generated tool patterns (mock mode)</name>
  <files>None (verification only)</files>
  <action>
Run the tool generation in mock mode to verify the SYSTEM_PROMPT change doesn't break existing functionality:

1. Ensure no API key is set (mock mode)
2. Run a calculation task
3. Verify the mock output still parses correctly

Note: The mock LLM response is hardcoded and won't change with SYSTEM_PROMPT updates, but this verifies the adapter still works. Real LLM testing requires API_KEY to be set.
  </action>
  <verify>
Run verification:

```bash
cd fin_evo_agent

# Unset API key to ensure mock mode
unset API_KEY

# Run task and verify code is generated
python3 -c "
from src.core.llm_adapter import LLMAdapter
adapter = LLMAdapter()
result = adapter.generate_tool_code('Calculate RSI indicator')
assert result['code_payload'] is not None, 'No code generated'
assert 'def calc_rsi' in result['code_payload'], 'Expected function not found'
assert 'prices: list' in result['code_payload'], 'Expected parameter signature not found'
print('Mock generation works correctly')
"
```

Exit code 0 and "Mock generation works correctly" output confirms success.
  </verify>
  <done>
Mock LLM adapter generates code with correct pattern (prices: list parameter, pure function structure).
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. SYSTEM_PROMPT inspection:
```bash
cd fin_evo_agent && python3 -c "from src.core.llm_adapter import SYSTEM_PROMPT; print(SYSTEM_PROMPT)"
```
Should show all the new instructions and example.

2. Requirements coverage check:
- PROMPT-03: "Use ONLY pandas and numpy" in SYSTEM_PROMPT
- PROMPT-04: "Accept price/financial data as function ARGUMENTS" in SYSTEM_PROMPT
- DATA-01: Same as PROMPT-04
- DATA-02: "FORBIDDEN inside generated tools: yfinance, akshare" in SYSTEM_PROMPT
- DATA-03: "Return typed results: float for single values, dict for multiple values, bool for conditions" in SYSTEM_PROMPT
</verification>

<success_criteria>
Phase 2 Plan 01 is complete when:

1. SYSTEM_PROMPT in llm_adapter.py includes all required instructions:
   - [x] Data-as-arguments pattern ("Accept price/financial data as function ARGUMENTS")
   - [x] No yfinance in allowed imports; yfinance in FORBIDDEN list
   - [x] pandas/numpy-only instruction ("Use ONLY pandas and numpy")
   - [x] Return type guidance ("float for single values, dict for multiple values, bool for conditions")
   - [x] Inline test data instruction
   - [x] Example of correct pattern

2. Verification commands pass:
   - [x] yfinance not in allowed imports section of SYSTEM_PROMPT
   - [x] FORBIDDEN list includes yfinance, akshare, talib
   - [x] Mock LLM adapter still generates valid code
</success_criteria>

<output>
After completion, create `.planning/phases/02-prompt-engineering/02-01-SUMMARY.md`
</output>
